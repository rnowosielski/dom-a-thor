
> dom-a-thor@0.0.0 test:coverage
> vitest run --coverage

Both esbuild and oxc options were set. oxc options will be used and esbuild options will be ignored.

 RUN  v3.2.4 /Users/rnowosielski/Projects/dom-a-thor-cursor
      Coverage enabled with v8

 ✓ src/__tests__/main.test.tsx (2 tests) 16ms
 ❯ src/chrome-extension/__tests__/content.test.js (9 tests | 8 failed) 30ms
   ✓ chrome-extension/content.js > fetchLandDetailsFromExtraDom > should extract land dimensions from ExtraDom page 20ms
   × chrome-extension/content.js > fetchLandDetailsFromExtraDom > should return null when no matching parameters found 3ms
     → Cannot read properties of undefined (reading '0')
   × chrome-extension/content.js > fetchLandDetailsFromExtraDom > should handle comma decimal separators 0ms
     → Cannot read properties of undefined (reading '0')
   × chrome-extension/content.js > fetchLandDetailsFromArchon > should extract land dimensions from Archon page 1ms
     → Cannot read properties of undefined (reading '0')
   × chrome-extension/content.js > fetchLandDetailsFromArchon > should return undefined when no matching product data found 1ms
     → Cannot read properties of undefined (reading '0')
   × chrome-extension/content.js > chrome message listener > should register message listener on load 3ms
     → expected "spy" to be called at least once
   × chrome-extension/content.js > chrome message listener > should handle getLandDetails action for extradom.pl 0ms
     → Cannot read properties of undefined (reading '0')
   × chrome-extension/content.js > chrome message listener > should handle getLandDetails action for archon.pl 0ms
     → Cannot read properties of undefined (reading '0')
   × chrome-extension/content.js > chrome message listener > should ignore other actions 0ms
     → Cannot read properties of undefined (reading '0')
 ❯ src/components/__tests__/DraggablePolygon.test.tsx (10 tests | 10 failed) 41ms
   × DraggablePolygon > should render without crashing 24ms
     → require() of ES Module /Users/rnowosielski/Projects/dom-a-thor-cursor/node_modules/react-leaflet/lib/index.js from /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx not supported.
Instead change the require of index.js in /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx to a dynamic import() which is available in all CommonJS modules.
   × DraggablePolygon > should handle coordinates prop correctly 2ms
     → require() of ES Module /Users/rnowosielski/Projects/dom-a-thor-cursor/node_modules/react-leaflet/lib/index.js from /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx not supported.
Instead change the require of index.js in /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx to a dynamic import() which is available in all CommonJS modules.
   × DraggablePolygon > should handle houseDataUrl prop correctly 2ms
     → require() of ES Module /Users/rnowosielski/Projects/dom-a-thor-cursor/node_modules/react-leaflet/lib/index.js from /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx not supported.
Instead change the require of index.js in /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx to a dynamic import() which is available in all CommonJS modules.
   × DraggablePolygon > should handle mirrorX and mirrorY props 2ms
     → require() of ES Module /Users/rnowosielski/Projects/dom-a-thor-cursor/node_modules/react-leaflet/lib/index.js from /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx not supported.
Instead change the require of index.js in /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx to a dynamic import() which is available in all CommonJS modules.
   × DraggablePolygon > should use default values for mirrorX and mirrorY 1ms
     → require() of ES Module /Users/rnowosielski/Projects/dom-a-thor-cursor/node_modules/react-leaflet/lib/index.js from /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx not supported.
Instead change the require of index.js in /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx to a dynamic import() which is available in all CommonJS modules.
   × DraggablePolygon > should handle null houseDataUrl 1ms
     → require() of ES Module /Users/rnowosielski/Projects/dom-a-thor-cursor/node_modules/react-leaflet/lib/index.js from /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx not supported.
Instead change the require of index.js in /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx to a dynamic import() which is available in all CommonJS modules.
   × DraggablePolygon > should handle empty coordinates array 1ms
     → require() of ES Module /Users/rnowosielski/Projects/dom-a-thor-cursor/node_modules/react-leaflet/lib/index.js from /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx not supported.
Instead change the require of index.js in /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx to a dynamic import() which is available in all CommonJS modules.
   × DraggablePolygon > should handle coordinates with less than 3 points 2ms
     → require() of ES Module /Users/rnowosielski/Projects/dom-a-thor-cursor/node_modules/react-leaflet/lib/index.js from /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx not supported.
Instead change the require of index.js in /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx to a dynamic import() which is available in all CommonJS modules.
   × DraggablePolygon > should return null (no visible content) 2ms
     → require() of ES Module /Users/rnowosielski/Projects/dom-a-thor-cursor/node_modules/react-leaflet/lib/index.js from /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx not supported.
Instead change the require of index.js in /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx to a dynamic import() which is available in all CommonJS modules.
   × DraggablePolygon > should handle image overlay creation errors 1ms
     → require() of ES Module /Users/rnowosielski/Projects/dom-a-thor-cursor/node_modules/react-leaflet/lib/index.js from /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx not supported.
Instead change the require of index.js in /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx to a dynamic import() which is available in all CommonJS modules.
 ✓ src/components/__tests__/DynamicCenter.test.tsx (8 tests) 21ms
 ✓ src/hooks/__tests__/useLocalStorage.test.ts (11 tests) 28ms
 ✓ src/__tests__/App.simple.test.tsx (7 tests) 98ms
 ❯ src/components/__tests__/DomAThor.test.tsx (16 tests | 16 failed) 64ms
   × DomAThor > should render without crashing 26ms
     → map.setView is not a function
   × DomAThor > should render with correct map container style 3ms
     → map.setView is not a function
   × DomAThor > should render DynamicCenter component 6ms
     → map.setView is not a function
   × DomAThor > should render TileLayer component 3ms
     → map.setView is not a function
   × DomAThor > should render DraggablePolygon component with correct props 2ms
     → map.setView is not a function
   × DomAThor > should handle mirrorX and mirrorY props 1ms
     → map.setView is not a function
   × DomAThor > should calculate house coordinates when dimensions change 1ms
     → map.setView is not a function
   × DomAThor > should not calculate house coordinates when width or height is 0 1ms
     → map.setView is not a function
   × DomAThor > should fetch land data when landIdentifier changes 1ms
     → map.setView is not a function
   × DomAThor > should not fetch land data when landIdentifier is undefined 1ms
     → map.setView is not a function
   × DomAThor > should handle land data fetch success 1ms
     → map.setView is not a function
   × DomAThor > should handle land data fetch error 5ms
     → map.setView is not a function
   × DomAThor > should render Polygon when land coordinates are available 2ms
     → map.setView is not a function
   × DomAThor > should not render Polygon when no land coordinates 2ms
     → map.setView is not a function
   × DomAThor > should use default center when no land data 3ms
     → map.setView is not a function
   × DomAThor > should set correct map properties 2ms
     → map.setView is not a function
 ✓ src/components/__tests__/DebugControls.test.tsx (12 tests) 166ms
 ✓ src/utils/__tests__/imageProcessor.test.ts (11 tests) 1243ms
   ✓ imageProcessor > cropToInnerRectangle > should scale large images  364ms
 ✓ src/utils/__tests__/coordinateUtils.test.ts (19 tests) 5ms
 ✓ src/hooks/__tests__/useChromeExtension.test.ts (1 test) 13ms
 ✓ src/types/__tests__/leaflet.test.ts (8 tests) 4ms
 ✓ src/utils/__tests__/leafletUtils.test.ts (10 tests) 5ms
 ✓ src/utils/__tests__/coordinateUtils.simple.test.ts (4 tests) 3ms
 ✓ src/utils/__tests__/leafletUtils.integration.test.ts (2 tests) 3ms

⎯⎯⎯⎯⎯⎯ Failed Tests 34 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  src/components/__tests__/DomAThor.test.tsx > DomAThor > should render without crashing
 FAIL  src/components/__tests__/DomAThor.test.tsx > DomAThor > should render with correct map container style
 FAIL  src/components/__tests__/DomAThor.test.tsx > DomAThor > should render DynamicCenter component
 FAIL  src/components/__tests__/DomAThor.test.tsx > DomAThor > should render TileLayer component
 FAIL  src/components/__tests__/DomAThor.test.tsx > DomAThor > should render DraggablePolygon component with correct props
 FAIL  src/components/__tests__/DomAThor.test.tsx > DomAThor > should handle mirrorX and mirrorY props
 FAIL  src/components/__tests__/DomAThor.test.tsx > DomAThor > should calculate house coordinates when dimensions change
 FAIL  src/components/__tests__/DomAThor.test.tsx > DomAThor > should not calculate house coordinates when width or height is 0
 FAIL  src/components/__tests__/DomAThor.test.tsx > DomAThor > should fetch land data when landIdentifier changes
 FAIL  src/components/__tests__/DomAThor.test.tsx > DomAThor > should not fetch land data when landIdentifier is undefined
 FAIL  src/components/__tests__/DomAThor.test.tsx > DomAThor > should handle land data fetch success
 FAIL  src/components/__tests__/DomAThor.test.tsx > DomAThor > should handle land data fetch error
 FAIL  src/components/__tests__/DomAThor.test.tsx > DomAThor > should render Polygon when land coordinates are available
 FAIL  src/components/__tests__/DomAThor.test.tsx > DomAThor > should not render Polygon when no land coordinates
 FAIL  src/components/__tests__/DomAThor.test.tsx > DomAThor > should use default center when no land data
 FAIL  src/components/__tests__/DomAThor.test.tsx > DomAThor > should set correct map properties
TypeError: map.setView is not a function
 ❯ src/components/DynamicCenter.tsx:12:13
     10| 
     11|     useEffect(() => {
     12|         map.setView(center); // Update the map's center
       |             ^
     13|     }, [center, map]);
     14| 
 ❯ Object.react_stack_bottom_frame node_modules/react-dom/cjs/react-dom-client.development.js:25989:20
 ❯ runWithFiberInDEV node_modules/react-dom/cjs/react-dom-client.development.js:874:13
 ❯ commitHookEffectListMount node_modules/react-dom/cjs/react-dom-client.development.js:13249:29
 ❯ commitHookPassiveMountEffects node_modules/react-dom/cjs/react-dom-client.development.js:13336:11
 ❯ commitPassiveMountOnFiber node_modules/react-dom/cjs/react-dom-client.development.js:15484:13
 ❯ recursivelyTraversePassiveMountEffects node_modules/react-dom/cjs/react-dom-client.development.js:15439:11
 ❯ commitPassiveMountOnFiber node_modules/react-dom/cjs/react-dom-client.development.js:15718:11
 ❯ recursivelyTraversePassiveMountEffects node_modules/react-dom/cjs/react-dom-client.development.js:15439:11
 ❯ commitPassiveMountOnFiber node_modules/react-dom/cjs/react-dom-client.development.js:15476:11

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/34]⎯

 FAIL  src/components/__tests__/DraggablePolygon.test.tsx > DraggablePolygon > should render without crashing
 FAIL  src/components/__tests__/DraggablePolygon.test.tsx > DraggablePolygon > should handle coordinates prop correctly
 FAIL  src/components/__tests__/DraggablePolygon.test.tsx > DraggablePolygon > should handle houseDataUrl prop correctly
 FAIL  src/components/__tests__/DraggablePolygon.test.tsx > DraggablePolygon > should handle mirrorX and mirrorY props
 FAIL  src/components/__tests__/DraggablePolygon.test.tsx > DraggablePolygon > should use default values for mirrorX and mirrorY
 FAIL  src/components/__tests__/DraggablePolygon.test.tsx > DraggablePolygon > should handle null houseDataUrl
 FAIL  src/components/__tests__/DraggablePolygon.test.tsx > DraggablePolygon > should handle empty coordinates array
 FAIL  src/components/__tests__/DraggablePolygon.test.tsx > DraggablePolygon > should handle coordinates with less than 3 points
 FAIL  src/components/__tests__/DraggablePolygon.test.tsx > DraggablePolygon > should return null (no visible content)
 FAIL  src/components/__tests__/DraggablePolygon.test.tsx > DraggablePolygon > should handle image overlay creation errors
Error: require() of ES Module /Users/rnowosielski/Projects/dom-a-thor-cursor/node_modules/react-leaflet/lib/index.js from /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx not supported.
Instead change the require of index.js in /Users/rnowosielski/Projects/dom-a-thor-cursor/src/components/__tests__/DraggablePolygon.test.tsx to a dynamic import() which is available in all CommonJS modules.
 ❯ src/components/__tests__/DraggablePolygon.test.tsx:63:22
     61|     const { container } = render(
     62|       <MapContainer>
     63|         <DraggablePolygon
       |                      ^
     64|           coordinates={mockCoordinates}
     65|           houseDataUrl="https://example.com/house.jpg"

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[2/34]⎯

 FAIL  src/chrome-extension/__tests__/content.test.js > chrome-extension/content.js > fetchLandDetailsFromExtraDom > should return null when no matching parameters found
TypeError: Cannot read properties of undefined (reading '0')
 ❯ src/chrome-extension/__tests__/content.test.js:99:83
     97| 
     98|       await import('../content.js');
     99|       const messageListener = mockChrome.runtime.onMessage.addListener…
       |                                                                                   ^
    100|       const mockSendResponse = vi.fn();
    101|       

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/34]⎯

 FAIL  src/chrome-extension/__tests__/content.test.js > chrome-extension/content.js > fetchLandDetailsFromExtraDom > should handle comma decimal separators
TypeError: Cannot read properties of undefined (reading '0')
 ❯ src/chrome-extension/__tests__/content.test.js:124:83
    122| 
    123|       await import('../content.js');
    124|       const messageListener = mockChrome.runtime.onMessage.addListener…
       |                                                                                   ^
    125|       const mockSendResponse = vi.fn();
    126|       

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[4/34]⎯

 FAIL  src/chrome-extension/__tests__/content.test.js > chrome-extension/content.js > fetchLandDetailsFromArchon > should extract land dimensions from Archon page
TypeError: Cannot read properties of undefined (reading '0')
 ❯ src/chrome-extension/__tests__/content.test.js:171:83
    169| 
    170|       await import('../content.js');
    171|       const messageListener = mockChrome.runtime.onMessage.addListener…
       |                                                                                   ^
    172|       const mockSendResponse = vi.fn();
    173|       

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[5/34]⎯

 FAIL  src/chrome-extension/__tests__/content.test.js > chrome-extension/content.js > fetchLandDetailsFromArchon > should return undefined when no matching product data found
TypeError: Cannot read properties of undefined (reading '0')
 ❯ src/chrome-extension/__tests__/content.test.js:190:83
    188| 
    189|       await import('../content.js');
    190|       const messageListener = mockChrome.runtime.onMessage.addListener…
       |                                                                                   ^
    191|       const mockSendResponse = vi.fn();
    192|       

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[6/34]⎯

 FAIL  src/chrome-extension/__tests__/content.test.js > chrome-extension/content.js > chrome message listener > should register message listener on load
AssertionError: expected "spy" to be called at least once
 ❯ src/chrome-extension/__tests__/content.test.js:202:56
    200|     it('should register message listener on load', async () => {
    201|       await import('../content.js');
    202|       expect(mockChrome.runtime.onMessage.addListener).toHaveBeenCalle…
       |                                                        ^
    203|     });
    204| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[7/34]⎯

 FAIL  src/chrome-extension/__tests__/content.test.js > chrome-extension/content.js > chrome message listener > should handle getLandDetails action for extradom.pl
TypeError: Cannot read properties of undefined (reading '0')
 ❯ src/chrome-extension/__tests__/content.test.js:212:83
    210| 
    211|       await import('../content.js');
    212|       const messageListener = mockChrome.runtime.onMessage.addListener…
       |                                                                                   ^
    213|       const mockSendResponse = vi.fn();
    214|       

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[8/34]⎯

 FAIL  src/chrome-extension/__tests__/content.test.js > chrome-extension/content.js > chrome message listener > should handle getLandDetails action for archon.pl
TypeError: Cannot read properties of undefined (reading '0')
 ❯ src/chrome-extension/__tests__/content.test.js:227:83
    225| 
    226|       await import('../content.js');
    227|       const messageListener = mockChrome.runtime.onMessage.addListener…
       |                                                                                   ^
    228|       const mockSendResponse = vi.fn();
    229|       

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[9/34]⎯

 FAIL  src/chrome-extension/__tests__/content.test.js > chrome-extension/content.js > chrome message listener > should ignore other actions
TypeError: Cannot read properties of undefined (reading '0')
 ❯ src/chrome-extension/__tests__/content.test.js:237:83
    235|     it('should ignore other actions', async () => {
    236|       await import('../content.js');
    237|       const messageListener = mockChrome.runtime.onMessage.addListener…
       |                                                                                   ^
    238|       const mockSendResponse = vi.fn();
    239|       

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[10/34]⎯


 Test Files  3 failed | 12 passed (15)
      Tests  34 failed | 96 passed (130)
   Start at  23:50:17
   Duration  3.09s (transform 1.07s, setup 1.98s, collect 3.25s, tests 1.74s, environment 11.00s, prepare 1.67s)

